{
  description = "Gaelan's nix-based systems configuration";

  inputs = {
    # Flakes we're going to depend on
    nixpkgs.url = github:nixos/nixpkgs/nixos-21.11;
    nixos-hardware.url = github:NixOS/nixos-hardware/master;

    home-manager= {
      url = "github:nix-community/home-manager/release-21.11";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    emacs-config = {
      url = github:RobotDisco/emacs-config;
      inputs.nixpkgs.follows = "nixpkgs";
    };

    darwin = {
      url = github:lnl7/nix-darwin/master;
      inputs.nixpkgs.follows = "nixpkgs";
    };

    deploy-rs.url = github:serokell/deploy-rs;
    sops-nix.url = github:Mic92/sops-nix;
  };

  # This is where we define our own stuff
  outputs = { self, nixpkgs, darwin, deploy-rs, emacs-config, home-manager,
              sops-nix, nixos-hardware, ... }:
    let
      gcdUtil = import ./lib {
        inherit (nixpkgs) lib;
        inherit nixpkgs;
      };

      common-nixos-modules = [
        ./nixos/profiles/common.nix
        sops-nix.nixosModules.sops
        { sops.gnupg.sshKeyPaths = [ "/etc/ssh/ssh_host_rsa_key"]; }
        { users.mutableUsers = false; }
        ./nixos/users/gaelan.nix
        ./nixos/users/root.nix
        {
          # I guess the nix overlays form doesn't do anything
          # magic, so I'm overriding it to add overlays
          # within the nixos module system itself?
          nixpkgs.overlays = [
            emacs-config.overlay
          ];
        }
      ];

      common-darwin-modules = [
        ./darwin/profiles/common.nix
        {
          # I guess the nix overlays form doesn't do anything
          # magic, so I'm overriding it to add overlays
          # within the nixos module system itself?
          nixpkgs.overlays = [
            emacs-config.overlay
          ];
        }
      ];

      common-home-manager-modules = [
        emacs-config.homeManagerModules.emacsConfig
      ];
    in

      {
        nixosConfigurations = {
          kaitain = nixpkgs.lib.nixosSystem
            {
              system = "x86_64-linux";
              modules = common-nixos-modules ++ [
                ./nixos/profiles/kvm-guest.nix
                ./nixos/profiles/sendmail.nix
                {
                  networking.hostName = "kaitain";

                  networking.interfaces.enp1s0.useDHCP = true;
                }
                {
                  services.prometheus = {
                    enable = true;

                    scrapeConfigs = [
                      {
                        job_name = "node";
                        static_configs = [
                          {
                            targets = [ "darktower.admin.robot-disco.net:9100" ];
                          }
                          {
                            targets = [ "chapterhouse.admin.robot-disco.net:9100" ];
                          }
                          {
                            targets = [ "kaitain.admin.robot-disco.net:9100" ];
                          }
                          {
                            targets = [ "salusa.admin.robot-disco.net:9100" ];
                          }
                        ];
                      }
                    ];
                  };

                  services.grafana = {
                    enable = true;
                    addr = "0.0.0.0";
                    domain = "kaitain.admin.robot-disco.net";

                    provision.enable = true;
                    provision.datasources = [
                      {
                        name = "Prometheus";
                        url = "http://localhost:9090";
                        type = "prometheus";
                      }
                    ];
                  };

                  networking.firewall.allowedTCPPorts = [ 3000 ];
                }
              ];
            };
          # The old manual way I ran dockerized services, which I want to replace
          # with either NixOS or Nomad
          salusa = nixpkgs.lib.nixosSystem
            {
              system = "x86_64-linux";
              modules = common-nixos-modules ++ [
                ./nixos/profiles/kvm-guest.nix
                ./nixos/profiles/sendmail.nix
                {
                  networking.firewall.checkReversePath = "loose";
                  networking.firewall.interfaces.enp1s0.allowedTCPPorts = [ 3306 5432 ];
                  networking.firewall.interfaces.vlan50.allowedTCPPorts = [ 80 443 ];

                  sops.secrets.vaultwarden_secrets = {
                    sopsFile = ./secrets/vaultwarden.yaml;
                    format = "yaml";
                  };

                  containers = {
                    vaultwarden = {
                      autoStart = true;
                      bindMounts."/var/lib/bitwarden_rs" = {
                        hostPath = "/srv/data/vaultwarden";
                        isReadOnly = false;
                      };
                      bindMounts."/run/secrets" = {
                        hostPath = "/run/secrets";
                        isReadOnly = true;
                      };
                      config = {
                        services.bitwarden_rs = {
                          enable = true;
                          dbBackend = "postgresql";
                          environmentFile = "/run/secrets/vaultwarden_secrets";
                          config = {
                            signups_allowed = false;
                            signups_verify = true;

                            domain = "https://vaultwarden.robot-disco.net";

                            invitation_org_name = "Robot Disco";

                            smtp_host = "out.teksavvy.com";
                            smtp_from = "gdcosta@gmail.com";
                            smtp_from_name = "Vaultwarden";

                            require_device_email=true;
                          };
                        };
                      };
                    };
                    databases = {
                      autoStart = true;
                      bindMounts = {
                        "/var/backup/postgresql" = {
                          hostPath = "/srv/backups/postgresql";
                          isReadOnly = false;
                        };
                        "/var/backup/mysql" = {
                          hostPath = "/srv/backups/mariadb";
                          isReadOnly = false;
                        };
                      };

                      config = {
                        services.postgresql = {
                          package = nixpkgs.legacyPackages."x86_64-linux".postgresql_13;
                          enable = true;
                          enableTCPIP = true;
                          authentication = ''
                            host vaultwarden vaultwarden samehost scram-sha-256
                          '';
                          settings.password_encryption = "scram-sha-256";
                        };
                        services.postgresqlBackup = {
                          enable = true;
                          location = "/var/backup/postgresql";
                          startAt = "*-*-* *:00,15,30,45:00";
                        };

                        services.mysql = {
                          enable = true;
                          package = nixpkgs.legacyPackages."x86_64-linux".mariadb;
                        };
                        services.mysqlBackup = {
                          enable = true;
                          databases = [ "ccnet_db" "seafile_db"  "seahub_db" ];
                          calendar = "*-*-* *:05,15,35,45:00";
                          location = "/var/backup/mysql";
                        };
                      };
                    };
                  };
                }
                ./nixos/services/seafile.nix
                {
                  fileSystems = {
                    "/srv/backups" = {
                      device = "chapterhouse.admin.robot-disco.net:/backups";
                      fsType = "nfs";
                    };
                    "/srv/data" = {
                      device = "chapterhouse.admin.robot-disco.net:/data";
                      fsType = "nfs";
                    };
                  };
                }
              ];
            };
          # My laptop
          arrakis2017 = nixpkgs.lib.nixosSystem
            {
              system = "x86_64-linux";
              modules = common-nixos-modules ++ [
                ./nixos/profiles/baremetal.nix
                ./nixos/machines/arrakis
                # The module that loads home-manager
                home-manager.nixosModules.home-manager
                # My anonymous module that has some (probably oughta be common
                # settings and my user's customized home-manager config
                {
                  home-manager.useUserPackages = true;
                  home-manager.useGlobalPkgs = true;
		              home-manager.sharedModules = common-home-manager-modules;
                }
		            {
	                home-manager.users.gaelan = {
		                imports = [
		                  ./home-manager/users/gaelan
		                  ./home-manager/modules/user/gaelan/base.nix
		                ];
                    config = {
                      robotdisco.user.gaelan.base.enable = true;
		                };
                  };
                }
                {
                  fileSystems."/home/gaelan/fileserver" = {
                    device = "chapterhouse.admin.robot-disco.net:/archive";
                    fsType = "nfs";
                    options = [
                      "x-systemd.automount"
                      "user"
                      "noauto"
                      "x-systemd.idle-timeout=600"
                    ];
                  };
                }
              ];
            };
          # My hypervisor
          darktower = nixpkgs.lib.nixosSystem
            {
              system = "x86_64-linux";

              modules = common-nixos-modules ++ [
                ./nixos/profiles/baremetal.nix
                ./nixos/machines/darktower
                ./nixos/profiles/hypervisor.nix
                ./nixos/profiles/hardware/ups.nix
                ./nixos/profiles/sendmail.nix
                {
                  # Since I don't use my pfSense router to set policy for my VMs
                  # it makes more sense to use bridge mode for better performance
                  # especially since a lot of this traffic will be storage traffic
                  networking.macvlans = {
                    admin = {
                      interface = "eno1";
                      mode  = "bridge";
                    };
                    cloud = {
                      interface = "enp6s0f0";
                      mode = "bridge";
                    };
                  };
                }
              ];
            };
          chapterhouse = nixpkgs.lib.nixosSystem {
            system = "x86_64-linux";

            modules = common-nixos-modules ++ [
              ./nixos/profiles/kvm-guest.nix
              ./nixos/profiles/sendmail.nix
              {
                services.nfs.server.enable = true;
                networking.firewall.interfaces.enp2s0.allowedTCPPorts = [ 2049 ];
              }
              {
                # I very much care about the health of my fileserver data
                services.smartd = {
                  enable = true;
                  # I only care about real drives, not system VM drives
                  devices = [
                    {
                      device = "/dev/sda";
                    }
                    {
                      device = "/dev/sdb";
                    }
                    {
                      device = "/dev/sdc";
                    }
                    {
                      device = "/dev/sdd";
                    }
                    {
                      device = "/dev/sde";
                    }
                    {
                      device = "/dev/sdf";
                    }
                    {
                      device = "/dev/sdg";
                    }
                    {
                      device = "/dev/sdh";
                    }
                  ];
                  autodetect = false;
                  notifications = {
                    mail.sender = "root@robot-disco.net";
                    mail.enable = true;
                    mail.recipient = "gdcosta@gmail.com";
                  };
                  # Enable offline tests, schedule long/sort SMART tests as above
                  defaults.monitored = "-a -o on -s (S/../(05|12|19|26)/./03|L/../(08|22)/./03)";
                };
              }
              {
                sops.secrets."storagepool_archive_waterworld.key" = {
                  sopsFile = ./secrets/storagepool_archive_waterworld.key;
                  format = "binary";
                };
                sops.secrets."storagepool_archive_documents.key" = {
                  sopsFile = ./secrets/storagepool_archive_documents.key;
                  format = "binary";
                };
              }
            ];
          };
        };

        deploy.nodes = {
          darktower = {
            fastConnection = true;
            user = "root";
            sshUser = "gaelan";
            hostname = "darktower.admin.robot-disco.net";
            profiles.system = {
              path = deploy-rs.lib.x86_64-linux.activate.nixos self.nixosConfigurations.darktower;
            };
          };
          chapterhouse = {
            fastConnection = true;
            user = "root";
            sshUser = "gaelan";
            hostname = "chapterhouse.admin.robot-disco.net";
            profiles.system = {
              path = deploy-rs.lib.x86_64-linux.activate.nixos self.nixosConfigurations.chapterhouse;
            };
          };
          salusa = {
            fastConnection = true;
            user = "root";
            sshUser = "gaelan";
            hostname = "salusa.admin.robot-disco.net";
            profiles.system = {
              path = deploy-rs.lib.x86_64-linux.activate.nixos self.nixosConfigurations.salusa;
            };
          };
          kaitain = {
            fastConnection = true;
            user = "root";
            sshUser = "gaelan";
            hostname = "kaitain.admin.robot-disco.net";
            profiles.system = {
              path = deploy-rs.lib.x86_64-linux.activate.nixos self.nixosConfigurations.kaitain;
            };
          };
        };

        checks = builtins.mapAttrs (system: deployLib: deployLib.deployChecks self.deploy) deploy-rs.lib;

        darwinConfigurations.caladan = darwin.lib.darwinSystem {
          modules = common-darwin-modules ++ [
            home-manager.darwinModules.home-manager
            {
              # Set laptop hostname
              networking.hostName = "caladan";
            }
            {
              # Set up my name and make sure it runs zsh
              users.users."gaelan.dcosta" = {
                description = "Gaelan D'costa";
                shell = nixpkgs.zsh;
              };
            }
            {
              # My anonymous module that has some (probably oughta be common
              # settings and my user's customized home-manager config
              home-manager.useUserPackages = true;
              home-manager.useGlobalPkgs = true;
              home-manager.users."gaelan.dcosta" =
                import ./home-manager/users/gaelan/default.nix;
            }
          ];
        };
      };
}
